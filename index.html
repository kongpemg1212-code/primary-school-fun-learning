<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å­¦ç”Ÿè¶£å‘³å­¦ä¹ ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/roughjs@latest/bundled/rough.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .font-kids { font-family: 'ZCOOL XiaoWei', serif; }
        .paper-bg { background-color: #fdf6e3; background-image: radial-gradient(#eee8d5 1px, transparent 0); background-size: 20px 20px; }
        .hidden-word { color: transparent; border-bottom: 2px dashed #93a1a1; margin: 0 4px; padding: 0 8px; transition: all 0.3s; }
        .hidden-word:hover { color: rgba(147, 161, 161, 0.3); }
        [v-cloak] { display: none; }
        .tab-active { @apply bg-white shadow-md text-blue-600; }
        .drag-item { cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
        .drag-item:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; }
        .sortable-chosen { @apply border-orange-500 shadow-lg; }
    </style>
</head>
<body class="paper-bg min-h-screen text-slate-800">
    <div id="app" v-cloak class="max-w-2xl mx-auto p-4 md:p-8">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 bg-white/50 backdrop-blur p-4 rounded-3xl border border-slate-200">
            <h1 class="text-2xl font-black text-blue-600 flex items-center gap-2">
                <i class="ph-fill ph-graduation-cap"></i> è¶£å‘³å­¦ä¹ 
            </h1>
            <div class="flex gap-2">
                <button @click="subject = 'Chinese'" :class="['px-4 py-2 rounded-xl text-sm font-bold transition', subject === 'Chinese' ? 'bg-orange-500 text-white shadow-lg' : 'bg-slate-200 text-slate-500']">è¯­æ–‡</button>
                <button @click="subject = 'Math'" :class="['px-4 py-2 rounded-xl text-sm font-bold transition', subject === 'Math' ? 'bg-blue-500 text-white shadow-lg' : 'bg-slate-200 text-slate-500']">æ•°å­¦</button>
            </div>
        </header>

        <!-- Lesson List -->
        <div v-if="!currentLesson" class="space-y-4 animate-fade-in">
            <h2 class="text-xl font-bold flex items-center gap-2"><i class="ph-bold ph-list"></i> è¯¾ç¨‹åˆ—è¡¨</h2>
            <div class="grid grid-cols-1 gap-4">
                <button v-for="lesson in filteredLessons" :key="lesson.id" @click="selectLesson(lesson)" class="group p-6 bg-white rounded-3xl border-2 border-transparent hover:border-orange-400 hover:shadow-xl transition-all text-left flex items-center justify-between">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">{{ lesson.subject === 'Chinese' ? 'è¯­æ–‡' : 'æ•°å­¦' }}</div>
                        <div class="text-xl font-black group-hover:text-orange-600">{{ lesson.title }}</div>
                    </div>
                    <i class="ph-bold ph-caret-right text-slate-300 group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </div>

        <!-- Content View -->
        <div v-else class="animate-fade-in">
            <button @click="currentLesson = null" class="mb-4 flex items-center gap-1 text-slate-400 font-bold hover:text-slate-600 transition">
                <i class="ph-bold ph-arrow-left"></i> è¿”å›åˆ—è¡¨
            </button>

            <!-- è¯­æ–‡æ¨¡å—ï¼šèƒŒè¯µç¥å™¨ + æ‹–æ‹½æ’åº -->
            <div v-if="currentLesson.subject === 'Chinese'" class="space-y-6">
                
                <!-- æ¨¡å—åˆ‡æ¢ -->
                <div class="flex p-1 bg-slate-200 rounded-2xl mb-2 w-fit mx-auto">
                    <button @click="chineseTab = 'recite'" :class="['px-6 py-2 rounded-xl text-sm font-black transition', chineseTab === 'recite' ? 'bg-white shadow-sm text-orange-600' : 'text-slate-500']">èƒŒè¯µç¥å™¨</button>
                    <button @click="initSortingGame" :class="['px-6 py-2 rounded-xl text-sm font-black transition', chineseTab === 'sort' ? 'bg-white shadow-sm text-orange-600' : 'text-slate-500']">è¯­åºæŒ‘æˆ˜</button>
                </div>

                <div v-if="chineseTab === 'recite'" class="bg-white rounded-[2.5rem] p-8 shadow-2xl border border-orange-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-orange-500"></div>
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-kids font-black mb-2">{{ currentLesson.title }}</h2>
                        <div class="text-sm text-slate-400">{{ currentLesson.content.category }}</div>
                    </div>

                    <!-- æ¸è¿›æŒ–ç©ºæ§åˆ¶æ  -->
                    <div class="flex justify-center gap-2 mb-10 bg-slate-100 p-2 rounded-2xl">
                        <button v-for="n in 4" :key="n" @click="poemStep = n" :class="['flex-1 py-2 rounded-xl text-xs font-black transition', poemStep === n ? 'bg-white shadow-sm text-orange-600' : 'text-slate-400']">
                            ç¬¬ {{ n }} å…³
                        </button>
                    </div>

                    <!-- è¯¾æ–‡å†…å®¹ -->
                    <div class="flex flex-col items-center space-y-6">
                        <div v-for="(line, idx) in currentLesson.content.sentences" :key="idx" class="text-2xl md:text-3xl font-kids tracking-wider leading-relaxed">
                            <template v-for="(char, cIdx) in line.split('')">
                                <span :class="{'hidden-word': isHidden(char, cIdx, idx)}">{{ char }}</span>
                            </template>
                        </div>
                    </div>
                    
                    <div class="mt-12 text-center">
                        <div class="text-[10px] text-slate-300 uppercase tracking-widest font-black">å½“å‰æŒ‘æˆ˜</div>
                        <div class="text-sm font-bold text-orange-400 mt-1">{{ stepDescription }}</div>
                    </div>
                </div>

                <!-- è¯­åºæŒ‘æˆ˜ç»„ä»¶ -->
                <div v-if="chineseTab === 'sort'" class="bg-white rounded-[2.5rem] p-8 shadow-2xl border border-orange-100 relative">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-black text-slate-700">è¯—å¥å¤§æ’é˜Ÿ</h2>
                        <p class="text-xs text-slate-400 mt-1">æŒ‰æ­£ç¡®é¡ºåºæ‹–æ‹½å¡ç‰‡</p>
                    </div>

                    <div id="sort-list" class="space-y-3">
                        <div v-for="line in shuffledSentences" :key="line" class="drag-item p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl text-center font-kids text-lg font-bold hover:bg-orange-50 hover:border-orange-200 transition-colors">
                            {{ line }}
                        </div>
                    </div>

                    <div class="mt-10 flex flex-col items-center gap-4">
                        <div v-if="isSortedCorrect" class="animate-bounce text-green-500 font-black flex items-center gap-2">
                             <i class="ph-fill ph-check-circle text-2xl"></i> å¤ªæ£’äº†ï¼é¡ºåºå®Œå…¨æ­£ç¡®ï¼
                        </div>
                        <button @click="checkSortOrder" class="w-full py-4 bg-orange-500 text-white rounded-2xl font-black shadow-lg active:scale-95 transition-transform">
                            æ£€æŸ¥ç­”æ¡ˆ
                        </button>
                        <button @click="initSortingGame" class="text-slate-400 text-sm font-bold hover:text-orange-500 transition">
                            é‡æ–°æ‰“ä¹±
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ•°å­¦æ¨¡å—ï¼šäº¤äº’å‡ ä½•ç”»å¸ƒ -->
            <div v-if="currentLesson.subject === 'Math'" class="space-y-6">
                <div class="bg-white rounded-[2.5rem] p-6 shadow-2xl border border-blue-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-black text-blue-600">{{ currentLesson.title }}</h3>
                            <p class="text-xs text-slate-400 mt-1">æ‹–åŠ¨é»„è‰²åœ†ç‚¹æ”¹å˜å½¢çŠ¶</p>
                        </div>
                        <div class="flex gap-2">
                            <button v-for="shape in currentLesson.content.shapes" :key="shape.type" 
                                    @click="selectShape(shape)" 
                                    :class="['w-10 h-10 rounded-xl flex items-center justify-center transition-all', activeShape && activeShape.type === shape.type ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-100 text-slate-400']">
                                <i :class="getShapeIcon(shape.type) + ' text-xl'"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ç”»å¸ƒåŒºåŸŸ -->
                    <div class="relative w-full aspect-square bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 overflow-hidden touch-none" 
                         id="canvas-container"
                         @mousedown="handleStart" @mousemove="handleMove" @mouseup="handleEnd"
                         @touchstart.passive="handleStart" @touchmove.passive="handleMove" @touchend="handleEnd">
                        <canvas id="math-canvas" class="w-full h-full"></canvas>
                        
                        <!-- äº¤äº’æ§åˆ¶ç‚¹ -->
                        <div v-for="(p, i) in points" :key="i"
                             class="absolute w-8 h-8 bg-yellow-400 border-4 border-white rounded-full shadow-lg -translate-x-1/2 -translate-y-1/2 cursor-move pointer-events-none z-10"
                             :style="{ left: p.x + 'px', top: p.y + 'px' }">
                        </div>
                    </div>

                    <!-- å›¾å½¢è¯´æ˜ -->
                    <div v-if="activeShape" class="mt-6 p-4 bg-blue-50 rounded-2xl border border-blue-100 animate-fade-in">
                        <div class="font-black text-blue-700 mb-1">{{ activeShape.name }}</div>
                        <p class="text-sm text-blue-600/80 leading-relaxed">{{ activeShape.desc }}</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    subject: 'Chinese',
                    lessons: [],
                    currentLesson: null,
                    chineseTab: 'recite', // recite, sort
                    poemStep: 1, // 1: å…¨æ˜¾, 2: æŒ–è¯, 3: ç•™é¦–å­—, 4: å…¨ç©º
                    shuffledSentences: [],
                    isSortedCorrect: false,
                    sortInstance: null,
                    // æ•°å­¦çŠ¶æ€
                    activeShape: null,
                    points: [],
                    isDragging: false,
                    dragIndex: -1,
                    rc: null
                }
            },
            computed: {
                filteredLessons() {
                    return this.lessons.filter(l => l.subject === this.subject);
                },
                stepDescription() {
                    const desc = {
                        1: "æœ—è¯»é˜¶æ®µï¼šç†Ÿæ‚‰è¯¾æ–‡å†…å®¹",
                        2: "åˆçº§æŒ‘æˆ˜ï¼šæ‰¾å‡ºå¹¶è¡¥å…¨åŠ¨è¯",
                        3: "ä¸­çº§æŒ‘æˆ˜ï¼šæ ¹æ®é¦–å­—èƒŒè¯µå…¨å¥",
                        4: "ç»ˆææŒ‘æˆ˜ï¼šé—­çœ¼é»˜èƒŒæ•´ç¯‡"
                    };
                    return desc[this.poemStep];
                }
            },
            async mounted() {
                await this.fetchData();
            },
            methods: {
                async fetchData() {
                    try {
                        const res = await fetch('data/lessons.json?t=' + Date.now());
                        this.lessons = await res.json();
                    } catch (e) {
                        console.error("Data load failed", e);
                    }
                },
                selectLesson(lesson) {
                    this.currentLesson = lesson;
                    this.chineseTab = 'recite';
                    this.poemStep = 1;
                    if (lesson.subject === 'Math') {
                        this.selectShape(lesson.content.shapes[0]);
                    }
                },
                // æ•°å­¦é€»è¾‘
                getShapeIcon(type) {
                    return {
                        'rectangle': 'ph-fill ph-rectangle',
                        'square': 'ph-fill ph-square',
                        'triangle': 'ph-fill ph-triangle',
                        'circle': 'ph-fill ph-circle'
                    }[type] || 'ph-fill ph-shapes';
                },
                selectShape(shape) {
                    this.activeShape = shape;
                    this.initCanvas(shape.type);
                },
                initCanvas(type) {
                    this.$nextTick(() => {
                        const canvas = document.getElementById('math-canvas');
                        const container = document.getElementById('canvas-container');
                        const size = container.offsetWidth;
                        canvas.width = size;
                        canvas.height = size;
                        this.rc = rough.canvas(canvas);
                        
                        const mid = size / 2;
                        const offset = size / 4;
                        if (type === 'rectangle' || type === 'square') {
                            this.points = [
                                { x: mid - offset, y: mid - offset/2 },
                                { x: mid + offset, y: mid + offset/2 }
                            ];
                        } else if (type === 'triangle') {
                            this.points = [
                                { x: mid, y: mid - offset },
                                { x: mid - offset, y: mid + offset },
                                { x: mid + offset, y: mid + offset }
                            ];
                        } else if (type === 'circle') {
                            this.points = [
                                { x: mid, y: mid },
                                { x: mid + offset, y: mid }
                            ];
                        }
                        this.draw();
                    });
                },
                draw() {
                    const canvas = document.getElementById('math-canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    if (!this.activeShape) return;
                    const type = this.activeShape.type;
                    const style = { stroke: '#2563eb', strokeWidth: 3, fill: 'rgba(59, 130, 246, 0.1)', fillStyle: 'hachure' };

                    if (type === 'rectangle' || type === 'square') {
                        const [p1, p2] = this.points;
                        let w = p2.x - p1.x;
                        let h = p2.y - p1.y;
                        if (type === 'square') {
                            const side = Math.max(Math.abs(w), Math.abs(h));
                            w = w > 0 ? side : -side;
                            h = h > 0 ? side : -side;
                        }
                        this.rc.rectangle(p1.x, p1.y, w, h, style);
                    } else if (type === 'triangle') {
                        const [p1, p2, p3] = this.points;
                        this.rc.polygon([[p1.x, p1.y], [p2.x, p2.y], [p3.x, p3.y]], style);
                    } else if (type === 'circle') {
                        const [c, r] = this.points;
                        const dist = Math.sqrt(Math.pow(r.x - c.x, 2) + Math.pow(r.y - c.y, 2));
                        this.rc.circle(c.x, c.y, dist * 2, style);
                    }
                },
                handleStart(e) {
                    const rect = document.getElementById('canvas-container').getBoundingClientRect();
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    const x = clientX - rect.left;
                    const y = clientY - rect.top;
                    
                    this.dragIndex = this.points.findIndex(p => Math.sqrt(Math.pow(p.x - x, 2) + Math.pow(p.y - y, 2)) < 30);
                    if (this.dragIndex > -1) this.isDragging = true;
                },
                handleMove(e) {
                    if (!this.isDragging) return;
                    const rect = document.getElementById('canvas-container').getBoundingClientRect();
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    const x = clientX - rect.left;
                    const y = clientY - rect.top;
                    
                    this.points[this.dragIndex] = { x, y };
                    this.draw();
                },
                handleEnd() {
                    this.isDragging = false;
                    this.dragIndex = -1;
                },
                // è¯­æ–‡é€»è¾‘
                isHidden(char, charIdx, lineIdx) {
                    if (this.poemStep === 1) return false;
                    if (this.poemStep === 4) return true;
                    if (this.poemStep === 3) return charIdx > 0;
                    if (this.poemStep === 2) {
                        const keywords = ['å¹', 'è½', 'é™', 'é£˜', 'å…¥', 'å‡º'];
                        return keywords.includes(char);
                    }
                    return false;
                },
                initSortingGame() {
                    this.chineseTab = 'sort';
                    this.isSortedCorrect = false;
                    const original = [...this.currentLesson.content.sentences];
                    this.shuffledSentences = original.sort(() => Math.random() - 0.5);
                    
                    this.$nextTick(() => {
                        const el = document.getElementById('sort-list');
                        if (this.sortInstance) this.sortInstance.destroy();
                        this.sortInstance = Sortable.create(el, {
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            chosenClass: 'sortable-chosen'
                        });
                    });
                },
                checkSortOrder() {
                    const el = document.getElementById('sort-list');
                    const currentOrder = Array.from(el.children).map(item => item.innerText.trim());
                    const original = this.currentLesson.content.sentences;
                    this.isSortedCorrect = (JSON.stringify(currentOrder) === JSON.stringify(original));
                    if (!this.isSortedCorrect) alert("é¡ºåºä¸å¯¹å“¦ï¼Œå†è¯•ä¸€æ¬¡å§ï¼ğŸ’ª");
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
